# ----------- BACKEND BUILD STAGE -----------
FROM python:3.9-alpine AS backend-build

WORKDIR /app/backend

RUN apk add --no-cache build-base python3-dev libffi-dev

# Create venv and install deps
RUN python3 -m venv /venv
COPY backend/requirements.txt .
RUN /venv/bin/pip install --upgrade pip && \
    /venv/bin/pip install --no-cache-dir -r requirements.txt

COPY backend/ .

# ----------- FINAL STAGE -----------
FROM nginx:alpine AS production

# ... (nginx setup)

COPY --from=backend-build /venv /venv
COPY --from=backend-build /app/backend /app/backend

# Install supervisor
RUN apk add --no-cache supervisor python3 libffi

# Set PATH to use venv
ENV PATH="/venv/bin:$PATH"

COPY ./supervisord.conf /etc/supervisord.conf

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisord.conf"]